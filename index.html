<!DOCTYPE html>
<html>
<head>
    <title>Mapski</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        #map {
            height: 96vh;
            width: 100%;
        }
    </style>
</head>
<script type="text/javascript">
let map;
let geocoder;
let bounds;
let markers = [];
let markerCluster;
let markerColor = 'red'; // Default marker color

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 38.662, lng: -40.993},
        zoom: 3,
        mapTypeControl: false, // Hide the default map type control
        fullscreenControl: true, // Enable the fullscreen control
        fullscreenControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM // Move the fullscreen control to the left bottom corner
        },
        streetViewControl: false // Hide the Street View Pegman control
    });

    geocoder = new google.maps.Geocoder();
    bounds = new google.maps.LatLngBounds();

    // Initialize the MarkerClusterer with custom styles
    markerCluster = new MarkerClusterer(map, [], {
        styles: [{
            url: "/m1.png",
            height: 53,
            width: 52,
            textColor: '#ffffff',
            textSize: 15
        }]
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map.setCenter(pos);
        }, function() {
            handleLocationError(true, map.getCenter());
        });
    } else {
        handleLocationError(false, map.getCenter());
    }
}

function handleLocationError(browserHasGeolocation, pos) {
    console.log(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
    map.setCenter(pos);
}

function geocodeLocation(userInput, maxRetries = 3) {
    return new Promise((resolve, reject) => {
        const attemptGeocode = (attempt = 1) => {
            geocoder.geocode({'address': userInput}, function(results, status) {
                if (status === 'OK') {
                    resolve({location: results[0].geometry.location, userInput});
                } else if (attempt < maxRetries) {
                    setTimeout(() => attemptGeocode(attempt + 1), 1000);
                } else {
                    reject('Geocode was not successful for the following reason: ' + status);
                }
            });
        };

        attemptGeocode();
    });
}

function downloadData(format) {
    const data = markers.map(marker => ({
        userInput: marker.userInput,
        lat: marker.getPosition().lat(),
        lng: marker.getPosition().lng()
    }));

    let text;
    if (format === 'json') {
        text = JSON.stringify(data);
    } else if (format === 'csv') {
        const rows = data.map(marker => `${marker.userInput},${marker.lat},${marker.lng}`);
        text = '"userInput","lat","lng"\n' + rows.join('\n');
    }

    const blob = new Blob([text], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `map_data.${format}`;
    link.click();

    URL.revokeObjectURL(url);
}

window.onload = function() {
    initMap();

    document.getElementById('mapType').addEventListener('change', function() {
        map.setMapTypeId(this.value);
    });

    document.getElementById('submitLocations').addEventListener('click', function() {
        const locationInput = document.getElementById('locationInput');
        const locations = locationInput.value.split('\n');
        const progressBar = document.getElementById('progressBar');
        const enableMarkerCluster = document.getElementById('markerCluster').checked;

        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);

        let delay = 0;
        locations.forEach((userInput, index) => {
            setTimeout(() => {
                geocodeLocation(userInput)
                    .then(result => {
                        const marker = new google.maps.Marker({
                            position: result.location,
                            icon: {
                                url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`
                            },
                            userInput: result.userInput
                        });

                        markers.push(marker);
                        if (enableMarkerCluster) {
                            markerCluster.addMarker(marker, false);
                        } else {
                            marker.setMap(map);
                        }

                        bounds.extend(marker.position);
                        map.fitBounds(bounds);

                        const progress = Math.round((index + 1) / locations.length * 100);
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);

                        // If all the locations have been geocoded
                        if (index === locations.length - 1) {
                            // Zoom out a little bit
                            const currentZoom = map.getZoom();
                            map.setZoom(currentZoom - 1);

                            // Trigger confetti
                            const confetti = window.confetti;
                            confetti({
                                particleCount: 100,
                                spread: 70,
                                origin: { y: 0.6 }
                            });                        }
                    })
                    .catch(error => console.error(error));
            }, delay);

            delay += 1000;
        });

        markerCluster.redraw();
        locationInput.value = '';
        $('#locationModal').modal('hide');
    });

    document.getElementById('downloadJson').addEventListener('click', function() {
        downloadData('json');
    });

    document.getElementById('downloadCsv').addEventListener('click', function() {
        downloadData('csv');
    });

    document.getElementById('viewResults').addEventListener('click', function() {
        const resultsTableBody = document.getElementById('resultsTableBody');

        // Clear the table body
        resultsTableBody.innerHTML = '';

        // Add a new row for each marker
        markers.forEach(marker => {
            const row = document.createElement('tr');

            const userInputCell = document.createElement('td');
            userInputCell.textContent = marker.userInput;
            row.appendChild(userInputCell);

            const latCell = document.createElement('td');
            latCell.textContent = marker.getPosition().lat();
            row.appendChild(latCell);

            const lngCell = document.createElement('td');
            lngCell.textContent = marker.getPosition().lng();
            row.appendChild(lngCell);

            resultsTableBody.appendChild(row);
        });
    });
    document.getElementById('saveSettings').addEventListener('click', function() {
        const mapType = document.getElementById('mapType').value;
        markerColor = document.getElementById('markerColor').value;

        map.setMapTypeId(mapType);

        $('#settingsModal').modal('hide');
    });
};

</script>
<body>
    <nav class="navbar navbar-light bg-light justify-content-between px-3">
        <a class="navbar-brand" href="#">Mapski</a>
        <div class="d-flex">
            <div class="dropdown">
                <button class="btn dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Results
                </button>
                <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                    <li><a class="dropdown-item" id="downloadJson" href="#">Download as JSON</a></li>
                    <li><a class="dropdown-item" id="downloadCsv" href="#">Download as CSV</a></li>
                    <li><a class="dropdown-item" id="viewResults" href="#" data-bs-toggle="modal" data-bs-target="#resultsModal">View Results</a></li>
                </ul>
            </div>
            <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#locationModal">Add Locations</button>
        </div>
    </nav>

    <div id="map"></div>
    <div class="progress" style="background-color: white; position: fixed; top: 0; left: 0; width: 100%; height: 2px; z-index: 1000;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; font-size:10px;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Add Locations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="locationInput" class="form-control" rows="5"></textarea>
                    <div class="mb-3 mt-3">
                        <label for="mapType" class="form-label">Map Type</label>
                        <select id="mapType" class="form-select">
                            <option value="roadmap">Roadmap</option>
                            <option value="satellite">Satellite</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="terrain">Terrain</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="markerColor" class="form-label">Marker Color</label>
                        <select id="markerColor" class="form-select">
                            <option value="red">Red</option>
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                            <option value="purple">Purple</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="markerCluster" checked>
                        <label class="form-check-label" for="markerCluster">Enable Marker Clustering</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitLocations">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultsModalLabel">Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">User Input</th>
                                <th scope="col">Latitude</th>
                                <th scope="col">Longitude</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_XL7phcJk-pe5RbLXg3aj-lzE4A-h81E&libraries=places"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-marker-clusterer/1.0.0/markerclusterer_compiled.js" integrity="sha512-DRb7DDx102X//EZzXafSrvSfM2vsm58IEdTpAlUAJPv27ziyWCoKL25E42yY+GJM6AEtCGzSrsQ9RPGfDnd1Cg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>


</body>
</html>
